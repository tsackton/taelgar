# Header Block Metadata

Each header block is generated by a combination of the ```generateHeader``` template and three dynamic header scripts: ```get_PageDatedValues, get_Affiliations, and get_Whereabouts```. Each of these four components uses different parts of the YAML frontmatter (metadata) to generate the correct data. Other YAML data can exist, but is not documented here.

## Metadata
The following metadata elements are recognized by the header scripts:

Note on versioning. The scripts add a `headerVersion` to the page when run, which helps understand what the current header version is and what pages might change if you regenerate the header. There is also a `version` attribute which allows use of an older header generation mechanic via setting `version: old` in the header.
#### Name Descriptors
These metadata items name the page

* `name` the page name (if not set, the file name is used)
* `title` the page title (i.e. Queen, Samraat, Captain, etc). Used when this title is defining - it becomes part of the name. See affiliations, below, for details on titles relative to a specific organization
* `pronunciation` used to document the pronunciation of the name
* `aliases` used to define other names for this thing
#### Kind Descriptors
These metadata items describe what the page is

* `typeOf` used to describe the type of something, i.e. "skyship", "vehicle", "city". Typically used for places and items. 
* `subTypeOf` used to describe the subtype of something, i.e. ruined, caravanesri, etc. Typically used for places and items.
* `ancestry` is used to describe the species or culture of something, i.e. Sembaran, elven, etc. Used for places, items, organizations, and people
* `species` is used to describe the species of a person. It is expected to link back to a species page either via aliases or the linkmap
* `subspecies` is used to describe a subtype of a subspecies (hag, lich, etc). May or may not link back to a descriptive page
* `rarity` is used to describe the rarity of an item

#### Other Descriptors
These are other simple metadata descriptors for a page

* `pronouns` used to set the pronouns if the gender-default is not appriopriate
* `gender` used to describe the gender. One of `male`, `female`, or `enby` typically but any string used here other than male or female will generate they/them pronouns
* `population` used to define the population of a place, either as a number or words. If this is in a number, it is prefaced with 'pop. ' when formatting for display
* `partOf` used to describe a larger event or organization this page is part of. It is not used for places and if set for a place it will be treated as a shorthand for whereabouts
* `ddbLink` can be used to link to a mechanics page

### Dates
There are a number of date-based metadata:

In general dates can be YYYY, YYYY-MM, or YYYY-MM-DD. 0001 is a special date that indicates "the beginning of time" and won't display in various date displays. 9999 is a special date that indicates "the end of time" and similarly won't display. For a person who is definitely dead but at an unknown long ago date, you can set the died to 0001 for example. Or if you set the end date of an away line to 9999 it will be true "forever" but not show a date.

* `pageTargetDate` can be used for debugging, to set the 'current date' for a page. In general this shouldn't be checked in
* `born` or `created` is used to define when the page started to exist. 
* `died` or `destroyed` is used to define when the page ended/died/etc

There are two parts of the display defaults (see below) which are very relevant to dates: `startStatus` which is the word (like born, created) to describe the creation of the page and `endStatus` which is a word like died, destroyed to describe the end status of the page.

### Campaign Info

The `campaignInfo` is a metadata structure that defines when various campaign activities occurred with this page. It has the format:

```
{
	campaign:  the prefix of the campaign this is relevant to, used for generating export blocks
	type: defaults to "seen" but is used to describe the interaction, i.e. "met", "killed", "glimpsed from afar", etc
	person: if set, overrides the actor, i.e. if only one member of a party was involved
	date: the date on which this occurred
	wParty (or format): a replacement format string for this line
}
```

Note that it is worthwhile to set the campaign block without any other details, as it defines that the campaign has interacted with this person and can be used in "does X party know about person Y" queries. But in general, without a date, no display information will be output.
### Whereabouts

The `whereabouts` section defines where a specific page is or has been. It has the format:

```
{
	location: a place, vehicle, person, etc
	type: home or away
	start: the start date of this whereabout line
	end: the end date of this whereabouts line
	formatSpecifier: a formatter for this whereabouts line - see formatting below for details
	format: an alias for formatSpecifier
	wOrigin: a replacement format string if this whereabout is used as an origin
	wHome: a replacement format string if this whereabout is used as a current home
	wPastHome: a replacement format string if this whereabout is used as a past home
	wCurrent: a replacement format string if this whereabout is used as a current location
	wPast: a replacement format string if this whereabout is used as a past current location,
	wLastKnown: a replacement format string if this whereabout is used as a last known
}
```

Note that the simple line: `whereabouts: place` is shorthand for:

`whereabouts: [{type: home, location: place}] `

And can be used when simple whereabouts are all that is required.

In general, the whereabouts information is used to calculate four different whereabouts types:

* The `origin` whereabout is the earliest home whereabout, or if there are multiples with the same date, the first in the file. It represents where someone is from
* The `home` whereabout is the home whereabout that is (a) valid (i.e. it has started and hasn't ended) and (b) with the most recent start date
* The `current` whereabout is the whereabout that is (a) valid (i.e. it has started and hasn't ended) and (b) has the most recent start date
* The `lastKnown` whereabout is only set if the current whereabout is not found (i.e. there are no valid current whereabouts). In that case, the lastKnown whereabout is the home or away whereabout with the most recent end date

In general, if a start date is not set for any whereabout it is assumed to be `0001`. If an end date is not set for a home whereabout, it is assumed to be `9999`. If an end date is not set for an away whereabout, it is assumed to be equal to the start date.
#### Type

There are currently only two valid types, `home` and `away`. 
- Type `away` always represents a location where something is
- Type `home` is used not just to represent location, but also creator/founder/maker/owner etc
	- Generally speaking, for people, home is where you are from and where you are based
	- Generally speaking, for things/organizations, home defines either founder/creator if it points to a person, or place founded/created if it points to a location. To get made by person in location, you need to set the whereabouts of the person for created date, as presumably that person must have been in that place at that time. 
	- For locations, home is always used to represent current physical location, as places cannot typically go on trips (if they can, they are probably vehicles, not places)
### Affiliations

The `affiliations` section defines organizations or places that this page is affiliated with or leads. It has the following structure:

```
{
	org: the name of the organization or place this page is affiliated with
	place: the name of the place this page is affiliated with
	type: primary, member, or leader
	title: A title to use for this affiliation, i.e. Cook, Navigator, Cultist, etc
	start: when the affiliation started
	end: when the affiliation ended,
	aNoDate (or format): a replacement format string for when the affiliation has no dates
	aPast (or formatPast): a replacement format string for when the affiliation is in the past
	aCurrent (or formatCurrent): a replacement format string for when the affiliation is current
}
```

There are some default rules to make data entry simpler:
* setting `place` instead of `org` is a shorthand for setting `org` and `type: leader`
* If the type is not set, it is considered to be  `member`
* If the type is leader the page's title is used for the title
* If the type is not leader, the title is "Member" if it is not set
* If the start date is not set it is considered `0001`
* if the end date is not set it is considered the page end date, if set, or `9999` otherwise

The type of "primary" drives display information, and should mostly be used for things without dates. See the display section below for more details.

An example of a ruler:
```
{
	place: Sembara,
	start: 1523,
	end: 1544,
	title: High King
}
```

An example of a halfling cook:
```
{
	org: The Wave Dancer,
	title: Cook,
	start: 1742
}
```

If the affiliation line is a string, it is shorthand for `{org: <value>, type: member }`, and note this can be mixed and matched, i.e.:

```
affiliations:
	- Great Library
	- Society of the Open Scroll
	- {org: Chardon, title: Councillor }
	- {org: Falarans, type: primary }
```

Some pages still have `leaderOf` - leaderOf if it exists is treated as affiliations with type: leader but in general should be migrated away from.

### Display Defaults

The display of a page is controlled by a set of display default lines that support [[Substitution Tokens|substitution tokens]] and are used to build each line. 

Each display default comes from either (a) the hardcoded default, (b) the metadata.json for the page type, (c) the page frontmatter, or (d) a specific campaignInfo, whereabout, or affiliation line. Display defaults are merged with priority of (d) then (c) then (b) then (a).

The display defaults structure is a JSON object like:

```JSON
requiredDisplayDefaults: {
	"startStatus": "",
	"endStatus": "",
	"wOrigin": "<origin:3ru>",
	"wOriginU": "<origin:u>",
	"wHome": "<home:3rU>",
	"wHomeU": "",
	"wPastHome": "<home:U>",
	"wPastHomeU": "",
	"wCurrent": "Current location: <current:3r>",
	"wPast": "<end:U> in <current:3r>",
	"wLastKnown": "Last known location (as of <lastknowndate>): <lastknown:3r>",
	"wLastNoDate": "Last known location: <lastknown:3r>",
	"wParty": "<met:U> by <person> on <target> in <current:3r>",
	"dCurrent": "<start:U> <startDate>",
	"dPastHasStart": "<start:U> <startDate> - <end> <endDate>",
	"dPast": "<end:U> <endDate>",
	"boxName": "Information",
	"partOf": "",
	"boxInfo": "",
	"aNoDate": "<affiliationtitle:t> of <org>",
	"aPast": "<affiliationtitle:t> of <org> (until <endDate>)",
	"aCurrent": "<affiliationtitle:t> of <org> (since <startDate>)",
	"aPastHasStart": "<affiliationtitle:t> of <org> (<startDate> - <endDate>)",
	"linkText": "",
	"defArt": ""
}
```

The meaning of each display default follows. The defaults for various types can be found in metadata.json:

* `startStatus` is used as a string token only (the "start" token)
* `endStatus` is used as a string token only (the "end" token)
* `wOrigin` is used by the get_Whereabouts script to display the origin whereabout, if it is different from the home whereabout
* `wOriginU` is used by the get_Whereabouts script to display the origin whereabout, if it is different from the home whereabout, and is unknown
* `wHome` is used by the get_Whereabouts script to display the home whereabout, if it exists
* `wHome` is used by the get_Whereabouts script to display the home whereabout, if it is unknown
* `wPastHome` is used by the get_Whereabouts script to display the home whereabout, if it exists and the page is in the past (died/destroyed)
* `wPastHomeU` is used by the get_Whereabouts script to display the home whereabout, if it is unknown, and the page is in the past (died/destroyed); should usually be ""
* `wCurrent` is used by the get_Whereabouts script to display the current whereabout
* `wPast` is used by the get_Whereabouts script to display the current whereabout, if it the page is in the past (died/destroyed)
* `wLastKnown` is used by the get_Whereabouts script to display the last known whereabout, if it exists and has a date
* `wLastNoDate` is used by the get_Whereabouts script to display the last known whereabout, if it exists and has no date (i.e. and end of 9999)
* `wParty` is used by the header generation script to generate the "last seen by party" lines
* `dCurrent` is used by the get_PageDatedValues script to generate the "page date" line when the page is "alive"
* `dPastHasStart` is used by the get_PageDatedValues script to generate the "page date" line when the page is "dead" and has a start date
* `dPast` is used by the get_PageDatedValues script to generate the "page date" line when the page is "dead" but did not have a start date
* `boxName` is used to name the header box
* `partOf` is the used by header generation to generate the "partOf" line
* `boxInfo` is used by header generation to generate the "secondaryInfo" line
* `aNoDate` is used by get_Affiliations to display an affiliation that has no start or end dates. 
* `aPast` is used by get_Affiliations to display an affiliation that has ended but has no start date
* `aCurrent` is used by get_Affiliations to display an affiliation that is current and has a start date
* `aPastHasStart` is used by get_Affiliations to display an affiliation that has ended and has a  start date
* `linkText` defines the word used for linking to a mechanics page. If it is blank/missing no D&D Beyond link is generated

Additionally, there is one special line for which the presence of the field has meaning, so it is not in the default structure:
* `defArt` this is the article to put in front of the name, i.e. the. If this is not in the displayDefaults at all, the code generates the for 2 or more word names and no article otherwise. If it is in the displayDefaults with no value, or "" as value, there is no article generated. Otherwise, it is used as the article

### File Types

As much as possible, the header generation code does not care about file types and just generates a header based on the available frontmatter. However, the display defaults are managed per file type, defined as follows:
* event: Any page with a DR or DR_end or CY or CY_end frontmatter element
* person: A page with a person tag of any sort (i.e. person/ruler, person/pc, person)
* place: A page with a place tag (place, place/settlement, etc) or a leaflet ```location``` frontmatter tag
* organization: A page with an organization tag
* item: A page with an item tag

Any other page uses the "unknown" file type and the associated unknown file type defaults.

### Header Format
The header block is basically:

```
# Display Name
*(pronuncation, if present)*
> [!info]+ Box name
> Secondary Info Line (see display defaults)
> Part of Line (see display defaults)
> Dynamic: Date Information
> Dynamic: Affilication Information
> > Dynamic: Location information (whereabouts)
> > Campaign information
```

