# Discord DM â€“ 2023-01-12

[2023-01-12 12:24 AM] rsulfuratus: I fiddled around a bit. A couple of issues:
    1) Templater appears to be depreciating dynamic commands (https://github.com/SilentVoid13/Templater/issues/913), so probably isn't smart to rely on them extensively. 
    2) your template feels too complicated to me to use in general. my issue is that I (very often) don't want to fill in all the NPC information when I create the note. in your basic template the only dynamic element is the ageBasedStuff, but nothing else is read from metadata so if you skip the prompt the template is useless. this is difficult because things like ancestry and origin and home need to be transformed for display
[2023-01-12 12:25 AM] rsulfuratus: I actually now think dataview is the correct solution. the approach would be:
[2023-01-12 12:25 AM] rsulfuratus: 1) define a display string that is a mix of markdown and computed values. 
    2) define compute the values
    3) output the string
[2023-01-12 12:26 AM] rsulfuratus: then the python converter code would read the display string, and compute the values in the same way. would just require that functions are named consistently, so ageString is always generated by get_ageString or something
[2023-01-12 07:25 AM] rsulfuratus: looking at this some more if we use dv.view() it would be possible to keep everything inline and not need the computed markdown string. dv.view takes a javascript file and an argument and returns the result. so you could do `$=await dv.view("/js/custom/getAgeString", { "arg1": "value1", etc })`
[2023-01-12 07:25 AM] rsulfuratus: that would be equivalent to the templater command in most respects
[2023-01-12 07:27 AM] rsulfuratus: There is also a js2py module that could in theory let the python code run the js functions
[2023-01-12 07:31 AM] rsulfuratus: You can also still use your templater code to fill out metadata
[2023-01-12 07:33 AM] Deciusmus: Aha, dv.view is nice
[2023-01-12 07:33 AM] Deciusmus: Thatâ€™s a good replacement for `<%+
[2023-01-12 07:33 AM] Deciusmus: I still think that the best general approach is a template that can rerun itself to refresh and preserve added stuff
[2023-01-12 07:33 AM] Deciusmus: So the idea is if you reinsert the template into an existing file it regens
[2023-01-12 07:34 AM] Deciusmus: That keeps the python divergence low
[2023-01-12 07:34 AM] Deciusmus: Use dataview only for stuff that changes when the file doesnâ€™t change
[2023-01-12 07:35 AM] rsulfuratus: the tricky bit is all the reformatting and linking
[2023-01-12 07:36 AM] rsulfuratus: well, I guess I mean in your template it is all mixed up with prompts and other stuff I don't want to use
[2023-01-12 07:38 AM] rsulfuratus: having a template you can insert that uses tp.frontmatter/javascript plus dv.view for dynamic elements is fine
[2023-01-12 08:30 AM] Deciusmus: I don't have a lot of time for this today, but basically I think that using big dataview blocks is a pain because it is hard to fix/change them.
    
    My ultimate goal would be something that is very easy to update dozens/hundreds of files when the template changes
[2023-01-12 08:58 AM] Deciusmus: So I was able to write a template that added a yaml element to frontmatter.
[2023-01-12 08:59 AM] Deciusmus: I think it would be pretty easy to have a template that just regenerates the bio block based on the latest frontmatter
[2023-01-12 08:59 AM] Deciusmus: Using dataview for the age bit
[2023-01-12 08:59 AM] rsulfuratus: do you mean automatically regenerates if it detects metadata changes, or that you reinsert to replace old text?
[2023-01-12 09:00 AM] rsulfuratus: I have a meeting at 9:30 but am hoping to push before then a template you can insert in a file that has yaml already and that produces the correct bio block using both templater and dataviewjs, so we can see what we think
[2023-01-12 09:04 AM] Deciusmus: I have a hotkey - CTL-ALT-A
    it just updates the file
[2023-01-12 09:04 AM] Deciusmus: you click into the file and hit ctl-alt-a and the bio block magically updates based on current yaml
[2023-01-12 09:04 AM] rsulfuratus: ah nice
[2023-01-12 09:04 AM] Deciusmus: I mean, it doesn't actuall work ye
[2023-01-12 09:04 AM] Deciusmus: and the moment it just adds a date to prove the concept
[2023-01-12 09:08 AM] Deciusmus: But I agree that prompts are not ideal. Here is what I was thinking:
    
    The NPC template is wired to a hotkey. When you press it, it does the following to the current file:
    
    * Adds any "core" NPC yaml tags that are missing
    * If the species, ancestry, home tags are blank, it tries to calculate from the current folder (if they are set, it preserves them)
    * If there is an age tag it removes it and sets the born tag based on current fantasy calendar date
    * If the name tag doesn't match the title it fixes it to match the title
    
    Once that is done, it regenerates the header block (i.e. h1 title + bio block) from the current yaml
[2023-01-12 09:09 AM] Deciusmus: In the bio block it makes everything static except the "age status" string
[2023-01-12 09:09 AM] rsulfuratus: I wouldn't change the name tag
[2023-01-12 09:10 AM] rsulfuratus: if there are two NPCs with the same name, you need the files to be "Zevi of the Ko'zula" and "Zevi of the Bek'eni" to avoid link collisons
[2023-01-12 09:10 AM] rsulfuratus: but the name should just be "Zevi"
[2023-01-12 09:10 AM] Deciusmus: right
[2023-01-12 09:10 AM] Deciusmus: makes sense
[2023-01-12 09:12 AM] Deciusmus: Other bits would include:
    * Add a dataview to generate the current whereabouts from the whereabouts tag
    * Fix the getAgeStatus to read the "dead" value from YAML, i.e. for Arcus you want it to be petrified but when you regen the bio block that would go away
[2023-01-12 09:12 AM] Deciusmus: * Read the folder ->` place / species / ancestory mapping from json config
[2023-01-12 09:12 AM] Deciusmus: Some more speculative ideas:
[2023-01-12 09:14 AM] Deciusmus: * Set the NPC/campaign/met|unmet|unaware via session note backlink searches (but is it valid to say as a default all npcs in session notes should be met?)
    * Set the lastPartySeenDate via session note backlink session (as long as session notes have a standardized date in the frontmatter) (again, is this worthwhile?)
[2023-01-12 09:14 AM] Deciusmus: Finally, you could imagine the whole thing keying on type
[2023-01-12 09:14 AM] rsulfuratus: "Set the NPC/campaign/met|unmet|unaware via session note backlink searches (but is it valid to say as a default all npcs in session notes should be met?)"
    
    No, definitely not. Any NPC in session notes should be at least "aware", but plenty of them are not "met"
[2023-01-12 09:15 AM] rsulfuratus: I don't think it is worth the hassle trying to autocode NPC tags, to be honest.
[2023-01-12 09:15 AM] rsulfuratus: I really prefer to think about this a bit
[2023-01-12 09:15 AM] Deciusmus: So you could add a similarly architected "Building" yaml/bioblock and then if the type: building was set it would generate the same type of data for a building
[2023-01-12 09:16 AM] Deciusmus: and you could do the same for a place
[2023-01-12 09:16 AM] Deciusmus: etc
[2023-01-12 09:16 AM] rsulfuratus: yeah, keying on type would be great. NPC and Building would get the most use I think
[2023-01-12 09:17 AM] Deciusmus: I was envisioning 4 ones that I'd use:
    - NPC
    - Ruler
    - Place
    - Building
[2023-01-12 09:17 AM] Deciusmus: Ruler is basically just NPC with regnal dates added
[2023-01-12 09:17 AM] rsulfuratus: what would Place be? the main thing I can see I guess is tagging systematic regions
[2023-01-12 09:17 AM] rsulfuratus: e.g. so you could query all the place notes in Dunmar
[2023-01-12 09:18 AM] Deciusmus: So for my Cleenseau campaign I have lots of little details about each little hamlet
[2023-01-12 09:18 AM] Deciusmus: population, for example
[2023-01-12 09:18 AM] rsulfuratus: ah right population, pronunciation, that sort of thing.
[2023-01-12 09:18 AM] Deciusmus: whether that's worth having in yaml I'm not sure but its kinda nice
[2023-01-12 09:18 AM] rsulfuratus: I haven't bothered with that for anything
[2023-01-12 09:18 AM] Deciusmus: I would actually love to have some way of auto-inserting distances between places
[2023-01-12 09:18 AM] Deciusmus: Right, because we move around a lot
[2023-01-12 09:19 AM] Deciusmus: My campaign is going to spend the first 10-12 sessions all within a small region
[2023-01-12 09:19 AM] rsulfuratus: also because there just aren't that many hamlets in Dunmar
[2023-01-12 09:19 AM] Deciusmus: So it is worth developing in a fair bit of detail
[2023-01-12 09:20 AM] rsulfuratus: distance between places is tricky. although there is a way to read cvs with dataview, so one could imagine looking up origin, destination in a big spreadsheet
[2023-01-12 09:20 AM] rsulfuratus: but that would not translate to the web well at all
[2023-01-12 09:21 AM] Deciusmus: but you could just do it in templater
[2023-01-12 09:21 AM] Deciusmus: have a CSV of distances and some yaml frontmatter like:
    
    nearby_places: `[a, b, c]`
[2023-01-12 09:21 AM] rsulfuratus: yeah that would be nice
[2023-01-12 09:21 AM] rsulfuratus: that's a good idea
[2023-01-12 09:21 AM] Deciusmus: and then the template would generate something like:
    
    Travel times:
    * Rinburg, blah blah
[2023-01-12 09:22 AM] Deciusmus: you could even get fancy and have the data provide a "good road", "bad road", "river" and then use some factor to generate time on foot / time on horse
[2023-01-12 09:22 AM] Deciusmus: honestly that would be a lot of value to me as the pcs start moving around the region and start asking how long it will take to get place to palace
[2023-01-12 09:23 AM] rsulfuratus: if you want to get fancy you could use templater to autogenerate a table
[2023-01-12 09:24 AM] rsulfuratus: I have a meeting soon and will be busy until about 3 after that although may fiddle on my lunch break
[2023-01-12 09:25 AM] rsulfuratus: I just pushed to the repo a commit that has _templates/templates/NPC-text-dataview.md
[2023-01-12 09:25 AM] Deciusmus: yeah, I have a lot of work coding to do, but might fiddle a bit this evening or during lunch
[2023-01-12 09:26 AM] rsulfuratus: _templates/templates/NPC-text-dataview.md works to generate a bioblock (might need a little bug checking) based on your original NPC template, but it inserts a dv.view line
[2023-01-12 09:27 AM] rsulfuratus: probably should refactor a bit to extract functions into a separate js file, either via templater user functions or with customjs (which would allow reusing the same functions in dataview blocks, if desired)
[2023-01-12 09:28 AM] rsulfuratus: there is also some other bits I wrote in metadataUtils.js for customjs - e.g. I was working on a general reformater function that takes a string, reformats it, and returns the reformatted value or different string if blank. might be worth using that instead of all the custom one-off reformatting code, for example
[2023-01-12 12:05 PM] rsulfuratus: Had two meetings canceled so messed around a bit over the past hour. Trying to reorg a bit. New _scripts folder with customJS and dv.view() code, trying to move most of the js out of the template and into a customJS class
[2023-01-12 12:06 PM] rsulfuratus: NPC-dataview-text is template that inserts header and bio, using inline dataviewjs for date
[2023-01-12 12:06 PM] rsulfuratus: A few bugs but mostly working
[2023-01-12 12:08 PM] rsulfuratus: Right now the metadataUtils class has functions for static metadata only, and the things that depend on age/campaign will be dv.view code. The template autogenerates the dv.view code
[2023-01-12 12:09 PM] rsulfuratus: In metadataUtils functions with TP_ should probably be moved to templater user scripts as they depend on the tp object and canâ€™t be reused
[2023-01-12 12:11 PM] rsulfuratus: Going to work on that during my lunch break and then do real work
[2023-01-12 12:17 PM] Deciusmus: So I'm working on a totally different approach than you ðŸ™‚
[2023-01-12 12:17 PM] rsulfuratus: what are you doing?
[2023-01-12 12:17 PM] Deciusmus: the auto-regen template stuff
[2023-01-12 12:18 PM] rsulfuratus: yeah but can't you just grab the templater code I have and use it?
[2023-01-12 12:18 PM] Deciusmus: maybe?
[2023-01-12 12:18 PM] Deciusmus: I'm mostly working at the obisidan vault API level
[2023-01-12 12:18 PM] Deciusmus: and raw-string manipulation in javascript
[2023-01-12 12:19 PM] rsulfuratus: but the idea is a templater template that reads the file, fixes up metadata, prints out a new bioblock and then appends all the text after the bioblock unchanged right?
[2023-01-12 12:19 PM] Deciusmus: yes
[2023-01-12 12:20 PM] rsulfuratus: so somewhere in there you still need a templater template to generate the bioblock
[2023-01-12 12:20 PM] Deciusmus: so I can definitely use the bioblock for the most part
[2023-01-12 12:20 PM] rsulfuratus: that is all I have done is the templater code to generate the bioblock
[2023-01-12 12:20 PM] Deciusmus: ah
[2023-01-12 12:20 PM] rsulfuratus: ```
    # `<% tp.frontmatter.name %>`
    >``[!info]`+ Basic information
    >``<% speciesDisplayValue %>``<% ancestryDisplayValue %>``<% pronounDisplayValue %>`
    >``$=dv.view("`<% dViewPath %>`get_PageDatedValue", {"currentYear" : (dv.current().yearOverride ? dv.current().yearOverride : FantasyCalendarAPI.getCalendars()`[0]`.current.year), "existYear" : `<% existYear %>`})`
    >``<% originDisplayValue %>`
    >``<% homeDisplayValue %>`
    ```
[2023-01-12 12:20 PM] rsulfuratus: it is basically this
[2023-01-12 12:21 PM] rsulfuratus: (with a javascript header)
[2023-01-12 12:21 PM] rsulfuratus: plus some reorg of javascripts so that the scripts called by dv.view, the generic manipulation methods from customJS and the custom functions for templater are all organized properly
[2023-01-12 12:21 PM] rsulfuratus: since they all require slightly different formats
[2023-01-12 12:22 PM] rsulfuratus: so in theory if you have a "GENERATE BIOBLOCK HERE" section of your template you should be able to just grab my template and stick it there
[2023-01-12 12:26 PM] Deciusmus: if your entire template was:
    
    `<%* tp.user.generateBioblock() %>`
    
    that would be nicer for me
[2023-01-12 12:26 PM] Deciusmus: my code has an array of strings and uses obsidian to re-write the file
[2023-01-12 12:26 PM] Deciusmus: so I can't actually type stuff into the template -- its all javascript
[2023-01-12 12:27 PM] Deciusmus: this works:
    
        newFileContent.push("`<% tp.date.now() %>`")
[2023-01-12 12:27 PM] Deciusmus: but it is a bit of a pain to have a lot of crap in that statement
[2023-01-12 12:27 PM] Deciusmus: there is probably a different way to do it, but I need to insert the content in the middle of the file
[2023-01-12 12:27 PM] rsulfuratus: yeah that should be possible
[2023-01-12 12:28 PM] rsulfuratus: ah hmm actually maybe not
[2023-01-12 12:28 PM] Deciusmus: actually
[2023-01-12 12:28 PM] rsulfuratus: I'm not sure if the templater user functions have access to customJS and FantasyCalendar api
[2023-01-12 12:28 PM] Deciusmus: I was using fantasy calendar API
[2023-01-12 12:28 PM] Deciusmus: but I'm not sure about customJs
[2023-01-12 12:28 PM] Deciusmus: window.FantasyCalendarAPI.getCalendars()`[0]`.current.year
[2023-01-12 12:28 PM] Deciusmus: works
[2023-01-12 12:29 PM] rsulfuratus: customJs isn't critical; I just wrote a few generic functions (to reformat metadata strings, get pronouns, and a few other small things) that could be useful to reuse elsewhere
[2023-01-12 12:29 PM] rsulfuratus: but could also just dump those functions in the generateBioblock() function
[2023-01-12 12:31 PM] rsulfuratus: actually the right way to do it is probably generateHeader(tp) and then depending on tp.frontmatter.type you can generate the correct header. would actually fix a lot of the messiness with the logic in getPageDatedValue if we could assume if type=Person that yearStart = born, yearEnd = died, etc
[2023-01-12 12:31 PM] Deciusmus: yeah
[2023-01-12 12:31 PM] rsulfuratus: let me fiddle a bit but that will be my goal is a `<%* tp.user.generateHeader(tp) %>` template that creates the markdown + dv.view inline code for a header
[2023-01-12 12:32 PM] rsulfuratus: then just need to fix my python script to parse functions as "`$=dv.view" instead of "`<%*"
[2023-01-12 12:32 PM] rsulfuratus: but that is easy
[2023-01-12 12:32 PM] rsulfuratus: just a bit of regex fiddling
[2023-01-12 12:34 PM] rsulfuratus: have you tried using a tp.user.FUNCTION call instead another tp.user function? I guess in theory if I pass the tp object all the user functions should get passed as well
[2023-01-12 12:34 PM] rsulfuratus: otherwise the code will get messy
[2023-01-12 12:53 PM] Deciusmus: I have not tried it
[2023-01-12 12:53 PM] rsulfuratus: it works
[2023-01-12 12:53 PM] Deciusmus: but I think it should work from the tp
[2023-01-12 12:54 PM] rsulfuratus: this is the entire template you need for the bioblock: 
    ```
    `<%* 
    const configFilePath = app.vault.getRoot().path + ".obsidian/taelgarConfig.json";
    let configFile = await app.vault.adapter.read(configFilePath);
    let output = tp.user.generateHeader(tp,configFile) 
    %>`
    `<% output %>`
    ```
[2023-01-12 12:55 PM] rsulfuratus: can't use await functions in tp.user so need to pass the configFile, but if you already load that elsewhere in your code then it could just be: 
    ``<%* tp.user.generateHeader(tp,configFile) %>``<% output %>``
[2023-01-12 12:55 PM] rsulfuratus: oops need the `let output = ` in there
[2023-01-12 12:55 PM] Deciusmus: cool
[2023-01-12 12:57 PM] Deciusmus: is it ok if I pass the parsed json object for the config file instead of the raw string
[2023-01-12 12:57 PM] rsulfuratus: yes, that's fine
[2023-01-12 12:58 PM] Deciusmus: so in theory I don't even need a template
[2023-01-12 12:58 PM] Deciusmus: I can just run your generateHeader
[2023-01-12 12:58 PM] Deciusmus: and then dump that in the filestream I'm re-writing
[2023-01-12 12:59 PM] rsulfuratus: yeah you could, it returns a multi-line markdown string
[2023-01-12 01:00 PM] rsulfuratus: ah, hmm. it takes the tp object and the config json as inputs
[2023-01-12 01:00 PM] rsulfuratus: it needs access to tp.frontmatter and tp.user
[2023-01-12 01:00 PM] Deciusmus: the tp.frontmatter won't be accurate
[2023-01-12 01:01 PM] Deciusmus: at the moment I think you have to do a 2-pass to get it to work
[2023-01-12 01:01 PM] Deciusmus: so I have ctl-alt-m to refresh the template
[2023-01-12 01:01 PM] Deciusmus: so you have to do c-a-m to update the template and then alt-r to replace templates in active file
[2023-01-12 01:03 PM] rsulfuratus: generateHeader could take metadata and config if I move the location parsing functions inside the generateHeader code
[2023-01-12 01:03 PM] rsulfuratus: ah hmm might still need access to tp for the tp.file.find_tfile in the location code
[2023-01-12 01:05 PM] rsulfuratus: but honestly a command to refresh yaml and a command to refresh templates is not really an issue
[2023-01-12 01:05 PM] Deciusmus: yeah
[2023-01-12 01:05 PM] Deciusmus: agreed
[2023-01-12 01:08 PM] rsulfuratus: the last thing I am doing is rewriting the PageDatedValue function so that it reads values for startPrefix, endPrefix, etc from metadata, otherwise each refresh will just set it back to defaults
[2023-01-12 01:09 PM] rsulfuratus: but I'm also going to base the defaults based on the type yaml value. for item will be created/destroyed, for npc will be born/died, for ruler will be born/died, and for building will be built/destroyed.
[2023-01-12 01:10 PM] rsulfuratus: these can be overwritten by metadata values but I'm getting rid of the strings argument
[2023-01-12 01:24 PM] rsulfuratus: okay it looks like it all works
[2023-01-12 02:05 PM] rsulfuratus: templateFunction template / generateHeader js works for type=NPC and type=Ruler, possibly with a few small visual bugs to fix if there are lots of missing values
[2023-01-12 09:35 PM] Deciusmus: what am I missing?
[2023-01-12 09:35 PM] Deciusmus: i'm getting dataview errors
[2023-01-12 09:41 PM] Deciusmus: Ok. It is working. I will push later, just not at my PC right now and don't currently have git setup on my surface
[2023-01-12 09:44 PM] Deciusmus: Here is what I have:
    
    Update Note template.
    * Bind it to a hotkey
    * Hit the hotkey
    * Hit Alt-R to rerun templates
    
    The update note template will:
    * Insert any missing metadata elements
    * Populate default values for the metadata elements based on folder data
    * Preserve any unrecognized metadata elements
    * Delete everything between the end of the YAML frontmatter and the first blank line
    * Insert your template into just below the YAML frontmatter
[2023-01-12 09:44 PM] Deciusmus: Hitting Alt-R will rerun the active template
[2023-01-12 09:44 PM] Deciusmus: So the workflow is basically:
    - Edit frontmatter
[2023-01-12 09:44 PM] Deciusmus: - Hit Alt-W / Alt-R
[2023-01-12 09:44 PM] Deciusmus: The bioblock is updated
[2023-01-12 09:45 PM] Deciusmus: Bonus features:
    - If we add new yaml elements they will be inserted
    - auto-pop of yaml elements based on folder structure
[2023-01-12 09:45 PM] Deciusmus: If the note is Untitled or contains only the single word RERUN it will prompt for NPC / age/ gender (and calc birth year from age)
[2023-01-12 09:48 PM] Deciusmus: .taelgarConfig drives the auto-pop so we can have different settings. There are three parts:
    
    rootTypes. A map from the folder root (i.e. people, campaigns, etc) to a type: value. 
    
    Example:
    ```
      "rootTypes": {
        "People": "NPC",
        "Gazetteer": "Place",
        "Thing": "Item"
      },
    ```
    
    typeKeys. A map from a type (read from the root types, above, or the type: in the YAML) to yaml keys that should be present.
    
    Example:
    ```
      "typeKeys" : {
        "NPC" : `["species", "born", "ancestry", "gender", "died", "home", "homeRegion", "origin", "originRegion", "affiliations" ]`,
        "Building" : `["built", "destroyed", "location", "locationRegion" ]`,
        "Place" : `["founded", "destroyed", "population", "prouncation", "location", "locationRegion"]`,
        "Item" : `["created", "destroyed", "currentOwner", "maker"]`
      },
    ```
[2023-01-12 09:50 PM] Deciusmus: typeKeyDefaults. A map of maps from a type and leaf folder to list of key-value pairs. This defines the default values for a yaml element.
    
    Example:
    ```
     "typeKeyDefaults" : {
        "NPC" : {
          "Sembarans" : {"species" : "human"}
        }
      }
    }
    ```
    
    This says that if the type is NPC, and the leaf folder of the file is Sembarans, then set the species value (if it is not in the yaml at all) to human.
[2023-01-12 09:51 PM] Deciusmus: Question: Should it replace
    
    ```species:```
    
    with 
    
    ```species: human```
    
    or only do that if the yaml element is truly missing?
[2023-01-12 11:24 PM] rsulfuratus: replacing `species: ` with `species: human` is fine. if you truly want species unknown, you would not rely on blank metadata and instead set `species: unknown`
[2023-01-12 11:37 PM] rsulfuratus: this is pretty awesome
[2023-01-12 11:44 PM] rsulfuratus: one small thing - there should be a way to set tags based on type. in particular I want all new NPCs I make to get NPC/unsorted as a default tag. maybe the best option would be default tags in the taelgarConfig.json, although it might make sense for us to agree on what the default tags should be

